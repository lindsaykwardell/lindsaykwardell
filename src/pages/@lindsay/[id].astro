---
import MicroblogPost from "../../layouts/MicroblogPost.astro";
// import Parser from 'rss-parser';
import dayjs from 'dayjs'

const { id } = Astro.params;

const data = await fetch(`https://mastodon.social/api/v1/statuses/${id}`).then(res => res.json())

const name = data.account.display_name
const post = data.content.replace(/<[^>]*>?/gm, '');
let snippet = post.substring(0,30);

if (snippet.length === 30) {
  snippet += "..."
}

const card = data.card;

const content = {
  title: name + ": " + snippet,
  snippet: post,
  image: data.media_attachments[0]?.url,
  slug: `/@lindsay/${id}`,
}
---
<MicroblogPost content={content}>
  <div class="bg-gray-200 dark:bg-gray-700 p-3 rounded my-4">
    <div class="flex items-center gap-4 h-12">
      <img src={data.account.avatar} class="w-10 h-10 rounded-full shadow" />
      <div class="flex flex-col flex-grow">
        <div>{data.account.display_name}</div>  
        <div class="text-sm">
          <a href="https://mastodon.social/@lindsaykwardell" class="decoration-gray-500 dark:decoration-gray-400">
            <span class="text-gray-500 dark:text-gray-400">@lindsay@lindsaykwardell.com</span>
          </a>
        </div>
      </div>
      <a href={data.url.replace("https://mastodon.social/@lindsaykwardell/", "/@lindsay/")} class="flex-shrink decoration-gray-500 dark:decoration-gray-400">
        <time class="text-gray-500 dark:text-gray-400">{dayjs(data.created_at).format("MMM DD YYYY")}</time>
      </a>
      <a href={data.url} aria-label="Open on Mastodon" target="_blank">
        <div class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white transition duration-150">
         <svg width="20" height="20" viewBox="0 0 16 16"><path fill="currentColor" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603c.348-1.778.32-4.339.32-4.339c0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091c.083 3.394.626 6.74 3.78 7.57c1.454.383 2.703.463 3.709.408c1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295c-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541c-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046c.456-.505 1.052-.764 1.793-.764c.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983c.74 0 1.336.259 1.791.764c.442.505.661 1.187.661 2.046v4.203z"/></svg>
        </div>
       </a>
    </div>
    <article class="px-5" set:html={data.content}></article>
    {data.media_attachments.length > 0 && (
      <div class="flex flex-col gap-4">
        {data.media_attachments.map((attachment) => (
          <img src={attachment.url} alt={attachment.description} class="rounded shadow" />
        ))}
      </div>
    )}
    {card && 
      <div class="shadow w-3/4 m-auto bg-gray-100 dark:bg-gray-800">
        <a href={card.url} class="no-underline" target="_blank">
          <img src={card.image} class="object-fill w-full" />
          <div class="p-3 pt-0">
            <div class="text-lg font-bold">{card.title}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">{card.description}</div>
          </div>
        </a>
      </div>
    }
  </div>
</MicroblogPost>